{{define "content"}}
<div class="repository-container">
    <div class="page-header">
        <div class="header-back">
            <a href="/repositories" class="btn btn-small">&larr; Back to Repositories</a>
        </div>
        <h1>{{.Data.RepoName}}</h1>
    </div>

    {{if .Error}}
    <div class="alert alert-error">{{.Error}}</div>
    {{end}}

    {{if .Data}}
    <div class="card">
        <section class="repo-details">
            <h2>Repository Details</h2>

            <div class="detail-field">
                <label>Name</label>
                <div class="detail-value">{{.Data.RepoName}}</div>
            </div>

            <div class="detail-field">
                <label>GitHub URL</label>
                <div class="detail-value">
                    <a href="{{.Data.Repository.GitHubURL}}" target="_blank" rel="noopener">{{.Data.Repository.GitHubURL}}</a>
                </div>
            </div>

            <div class="detail-field">
                <label>Webhook URL</label>
                <div class="input-group">
                    <input type="text" id="webhook-url" value="{{.Data.WebhookURL}}" readonly class="config-input">
                    <button type="button" class="btn-copy" data-copy-target="webhook-url">Copy</button>
                </div>
                <p class="field-note">Use <code>https://roxas.ai</code> - do NOT use <code>www.roxas.ai</code></p>
            </div>

            <div class="detail-field">
                <label>Status</label>
                <div class="detail-value">
                    <span class="status-badge status-active">Active</span>
                </div>
            </div>

            <div class="detail-field">
                <label>Added</label>
                <div class="detail-value">{{.Data.Repository.CreatedAt.Format "January 02, 2006 at 3:04 PM"}}</div>
            </div>
        </section>

        <section class="webhook-test">
            <h2>Webhook Test</h2>
            <p>Test your webhook configuration by sending a test ping.</p>
            <div class="action-buttons">
                <button type="button" id="test-webhook-btn" class="btn btn-primary" onclick="testWebhook()">Test Webhook</button>
                <span id="webhook-test-result"></span>
            </div>
        </section>

        <section class="webhook-actions">
            <h2>Webhook Secret</h2>
            <p>If your webhook secret has been compromised, you can regenerate it. This will invalidate the old secret.</p>
            <form action="/repositories/{{.Data.Repository.ID}}/webhook/regenerate" method="POST" onsubmit="return confirmRegenerate()">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <button type="submit" class="btn btn-warning">Regenerate Secret</button>
            </form>
        </section>

        <section class="repo-actions">
            <h2>Actions</h2>
            <div class="action-buttons">
                <a href="/repositories/{{.Data.Repository.ID}}/webhooks" class="btn btn-primary">View Webhook Deliveries</a>
                <a href="/repositories/{{.Data.Repository.ID}}/edit" class="btn btn-secondary">Edit Settings</a>
                <a href="/repositories/{{.Data.Repository.ID}}/delete" class="btn btn-danger">Delete Repository</a>
            </div>
        </section>
    </div>
    {{end}}
</div>

<script src="/static/js/clipboard.js"></script>
<script>
function confirmRegenerate() {
    return confirm('Are you sure you want to regenerate the webhook secret? The old secret will be invalidated and you will need to update your GitHub webhook settings.');
}

async function testWebhook() {
    const btn = document.getElementById('test-webhook-btn');
    const result = document.getElementById('webhook-test-result');

    btn.disabled = true;
    btn.textContent = 'Testing...';
    result.textContent = '';
    result.className = '';

    try {
        const response = await fetch('/repositories/{{.Data.Repository.ID}}/webhook/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            result.textContent = 'Success! Webhook responded with status ' + data.status_code;
            result.className = 'status-success';
        } else {
            result.textContent = 'Failed: ' + data.error;
            result.className = 'status-error';
        }
    } catch (error) {
        result.textContent = 'Error: ' + error.message;
        result.className = 'status-error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Test Webhook';
    }
}
</script>
{{end}}
