name: PR Cleanup Dev

# Cleanup workflow runs automatically when a PR is closed (removes all AWS resources)
on:
  pull_request:
    types: [closed]

jobs:
  cleanup-dev:
    name: Destroy Dev Environment
    runs-on: ubuntu-latest
    environment: dev

    permissions:
      pull-requests: write
      contents: read

    # Prevent concurrent cleanup operations for the same PR
    # Wait for any in-progress deployments to complete before cleaning up
    concurrency:
      group: deploy-dev-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform/service
        run: terraform init -backend-config=../backend-dev.hcl

      - name: Check if workspace exists
        id: check-workspace
        working-directory: terraform/service
        run: |
          if terraform workspace list | grep -q "dev-pr-${{ github.event.pull_request.number }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Workspace exists - will destroy"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Workspace doesn't exist - deployment was likely skipped"
          fi

      - name: Select Terraform Workspace
        if: steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        run: terraform workspace select dev-pr-${{ github.event.pull_request.number }}

      - name: Drop PR Database from Shared RDS
        if: steps.check-workspace.outputs.exists == 'true'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LAMBDA_NAME="roxas-shared-rds-cleanup"

          echo "Invoking cleanup Lambda for PR database pr_${PR_NUMBER}..."

          # Invoke the VPC Lambda to drop the database
          # The Lambda runs inside the VPC and can reach the private RDS
          RESPONSE=$(aws lambda invoke \
            --function-name "$LAMBDA_NAME" \
            --payload "{\"pr_number\": ${PR_NUMBER}, \"action\": \"drop\"}" \
            --cli-binary-format raw-in-base64-out \
            /tmp/lambda-response.json 2>&1) || {
            echo "Warning: Lambda invocation failed"
            echo "$RESPONSE"
            echo "Skipping database cleanup - proceeding with infrastructure teardown"
            exit 0
          }

          # Check Lambda response
          if [ -f /tmp/lambda-response.json ]; then
            cat /tmp/lambda-response.json
            STATUS_CODE=$(jq -r '.statusCode' /tmp/lambda-response.json 2>/dev/null || echo "unknown")
            ACTION=$(jq -r '.body.action' /tmp/lambda-response.json 2>/dev/null || echo "unknown")
            MESSAGE=$(jq -r '.body.message' /tmp/lambda-response.json 2>/dev/null || echo "unknown")

            echo ""
            echo "Lambda response: $MESSAGE (action: $ACTION)"

            if [ "$STATUS_CODE" = "200" ]; then
              echo "Database cleanup completed successfully"
            else
              echo "Warning: Lambda returned status $STATUS_CODE"
              echo "Proceeding with infrastructure teardown"
            fi
          else
            echo "Warning: No response file from Lambda"
            echo "Proceeding with infrastructure teardown"
          fi

      - name: Terraform Destroy
        if: steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          TF_VAR_linkedin_access_token: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          TF_VAR_webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
          TF_VAR_function_name: roxas-webhook-handler-pr-${{ github.event.pull_request.number }}
          TF_VAR_environment: dev
        run: terraform destroy -auto-approve

      - name: Cleanup Orphaned ENIs and Security Groups
        if: always() && steps.check-workspace.outputs.exists == 'true'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LAMBDA_NAME="roxas-shared-rds-cleanup"

          echo "Invoking cleanup Lambda for orphaned ENIs and security groups..."

          # Invoke the cleanup Lambda to remove orphaned ENIs and security groups
          # This actively cleans up resources instead of just waiting
          RESPONSE=$(aws lambda invoke \
            --function-name "$LAMBDA_NAME" \
            --payload "{\"pr_number\": ${PR_NUMBER}, \"action\": \"cleanup_all\"}" \
            --cli-binary-format raw-in-base64-out \
            /tmp/cleanup-response.json 2>&1) || {
            echo "Warning: Lambda invocation failed"
            echo "$RESPONSE"
            echo "Continuing with workflow - manual cleanup may be needed"
            exit 0
          }

          # Check Lambda response
          if [ -f /tmp/cleanup-response.json ]; then
            cat /tmp/cleanup-response.json
            STATUS_CODE=$(jq -r '.statusCode' /tmp/cleanup-response.json 2>/dev/null || echo "unknown")
            MESSAGE=$(jq -r '.body.message' /tmp/cleanup-response.json 2>/dev/null || echo "unknown")

            echo ""
            echo "Cleanup response: $MESSAGE"

            if [ "$STATUS_CODE" = "200" ]; then
              echo "ENI and security group cleanup completed successfully"
            else
              echo "Warning: Cleanup Lambda returned status $STATUS_CODE"
              echo "Manual cleanup may be needed"
            fi
          fi

      - name: Delete Terraform Workspace
        if: steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        run: |
          terraform workspace select default
          terraform workspace delete dev-pr-${{ github.event.pull_request.number }}

      - name: Comment PR with cleanup status
        if: steps.check-workspace.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const functionName = 'roxas-webhook-handler-dev-pr-${{ github.event.pull_request.number }}';

            const body = `### ðŸ§¹ Dev Environment Cleaned Up

            **Function:** \`${functionName}\`
            **Status:** Destroyed

            All AWS resources for this PR have been removed.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment PR - No cleanup needed
        if: steps.check-workspace.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### âœ… No Cleanup Needed

            No dev environment was deployed for this PR (deployment was skipped for documentation-only changes).`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
