name: PR Cleanup Dev

# Cleanup workflow runs automatically when a PR is closed (removes all AWS resources)
on:
  pull_request:
    types: [closed]

jobs:
  cleanup-dev:
    name: Destroy Dev Environment
    runs-on: ubuntu-latest
    environment: dev

    permissions:
      pull-requests: write
      contents: read

    # Prevent concurrent cleanup operations for the same PR
    # Wait for any in-progress deployments to complete before cleaning up
    concurrency:
      group: deploy-dev-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform/service
        run: terraform init -backend-config=../backend-dev.hcl

      - name: Check if workspace exists
        id: check-workspace
        working-directory: terraform/service
        run: |
          if terraform workspace list | grep -q "dev-pr-${{ github.event.pull_request.number }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Workspace exists - will destroy"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Workspace doesn't exist - deployment was likely skipped"
          fi

      - name: Select Terraform Workspace
        if: steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        run: terraform workspace select dev-pr-${{ github.event.pull_request.number }}

      - name: Drop PR Database
        id: drop-database
        if: steps.check-workspace.outputs.exists == 'true'
        continue-on-error: true
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LAMBDA_NAME="roxas-dev-cleanup"

          echo "Dropping PR database pr_${PR_NUMBER} via cleanup Lambda..."

          # Retry with exponential backoff (handles race condition with shared-infra deploy)
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "=== Attempt $i/$MAX_RETRIES ==="

            # Check if Lambda exists
            if ! aws lambda get-function --function-name "$LAMBDA_NAME" >/dev/null 2>&1; then
              if [ $i -lt $MAX_RETRIES ]; then
                WAIT=$((i * 15))
                echo "Lambda not found (may still be deploying). Waiting ${WAIT}s..."
                sleep $WAIT
                continue
              else
                echo "ERROR: Lambda $LAMBDA_NAME not available after $MAX_RETRIES attempts"
                exit 1
              fi
            fi

            echo "Lambda found, invoking..."

            # Invoke the VPC Lambda to drop the database
            if aws lambda invoke \
              --function-name "$LAMBDA_NAME" \
              --payload "{\"pr_number\": ${PR_NUMBER}, \"action\": \"drop\"}" \
              --cli-binary-format raw-in-base64-out \
              /tmp/lambda-response.json; then

              # Check Lambda response
              cat /tmp/lambda-response.json
              STATUS_CODE=$(jq -r '.statusCode' /tmp/lambda-response.json 2>/dev/null || echo "unknown")
              ACTION=$(jq -r '.body.action' /tmp/lambda-response.json 2>/dev/null || echo "unknown")
              MESSAGE=$(jq -r '.body.message' /tmp/lambda-response.json 2>/dev/null || echo "unknown")

              echo ""
              echo "Lambda response: $MESSAGE (action: $ACTION)"

              if [ "$STATUS_CODE" = "200" ]; then
                echo "Database cleanup completed successfully"
                exit 0
              else
                echo "ERROR: Lambda returned status $STATUS_CODE"
                exit 1
              fi
            else
              if [ $i -lt $MAX_RETRIES ]; then
                WAIT=$((i * 15))
                echo "Lambda invocation failed. Waiting ${WAIT}s before retry..."
                sleep $WAIT
                continue
              else
                echo "ERROR: Lambda invocation failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

          echo "ERROR: Unexpected exit from retry loop"
          exit 1

      - name: Terraform Destroy
        if: always() && steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          TF_VAR_linkedin_access_token: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          TF_VAR_webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
          TF_VAR_function_name: roxas-webhook-handler-pr-${{ github.event.pull_request.number }}
          TF_VAR_environment: dev
        run: terraform destroy -auto-approve

      - name: Cleanup Orphaned ENIs and Security Groups
        id: cleanup-enis
        if: always() && steps.check-workspace.outputs.exists == 'true'
        continue-on-error: true
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LAMBDA_NAME="roxas-dev-cleanup"

          echo "Cleaning up orphaned ENIs and security groups for PR ${PR_NUMBER}..."

          # Retry with exponential backoff
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "=== Attempt $i/$MAX_RETRIES ==="

            # Check if Lambda exists
            if ! aws lambda get-function --function-name "$LAMBDA_NAME" >/dev/null 2>&1; then
              if [ $i -lt $MAX_RETRIES ]; then
                WAIT=$((i * 15))
                echo "Lambda not found. Waiting ${WAIT}s..."
                sleep $WAIT
                continue
              else
                echo "ERROR: Lambda $LAMBDA_NAME not available after $MAX_RETRIES attempts"
                exit 1
              fi
            fi

            echo "Lambda found, invoking cleanup_all..."

            if aws lambda invoke \
              --function-name "$LAMBDA_NAME" \
              --payload "{\"pr_number\": ${PR_NUMBER}, \"action\": \"cleanup_all\"}" \
              --cli-binary-format raw-in-base64-out \
              /tmp/cleanup-response.json; then

              cat /tmp/cleanup-response.json
              STATUS_CODE=$(jq -r '.statusCode' /tmp/cleanup-response.json 2>/dev/null || echo "unknown")
              MESSAGE=$(jq -r '.body.message' /tmp/cleanup-response.json 2>/dev/null || echo "unknown")

              echo ""
              echo "Cleanup response: $MESSAGE"

              if [ "$STATUS_CODE" = "200" ]; then
                echo "ENI and security group cleanup completed successfully"
                exit 0
              else
                echo "ERROR: Cleanup Lambda returned status $STATUS_CODE"
                exit 1
              fi
            else
              if [ $i -lt $MAX_RETRIES ]; then
                WAIT=$((i * 15))
                echo "Lambda invocation failed. Waiting ${WAIT}s before retry..."
                sleep $WAIT
                continue
              else
                echo "ERROR: Lambda invocation failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

          echo "ERROR: Unexpected exit from retry loop"
          exit 1

      - name: Delete Terraform Workspace
        if: steps.check-workspace.outputs.exists == 'true'
        working-directory: terraform/service
        run: |
          terraform workspace select default
          terraform workspace delete dev-pr-${{ github.event.pull_request.number }}

      - name: Comment PR with cleanup status
        if: steps.check-workspace.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const functionName = 'roxas-webhook-handler-dev-pr-${{ github.event.pull_request.number }}';

            const body = `### ðŸ§¹ Dev Environment Cleaned Up

            **Function:** \`${functionName}\`
            **Status:** Destroyed

            All AWS resources for this PR have been removed.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment PR - No cleanup needed
        if: steps.check-workspace.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### âœ… No Cleanup Needed

            No dev environment was deployed for this PR (deployment was skipped for documentation-only changes).`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Check Lambda cleanup status
        if: always() && steps.check-workspace.outputs.exists == 'true'
        run: |
          # Fail the job if either Lambda step failed
          # This runs after terraform destroy to ensure infrastructure is cleaned up first
          if [ "${{ steps.drop-database.outcome }}" = "failure" ]; then
            echo "ERROR: Drop PR Database step failed"
            echo "The PR database may not have been cleaned up"
            exit 1
          fi
          if [ "${{ steps.cleanup-enis.outcome }}" = "failure" ]; then
            echo "ERROR: Cleanup Orphaned ENIs step failed"
            echo "Some ENIs or security groups may not have been cleaned up"
            exit 1
          fi
          echo "All Lambda cleanup steps completed successfully"
